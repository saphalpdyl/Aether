-- Plans define the service template: speeds, price, and the RADIUS policy
-- that gets pushed to the BNG when a subscriber connects.
CREATE TABLE plans (
    id               SERIAL      PRIMARY KEY,
    name             TEXT        NOT NULL UNIQUE,
    download_speed   INTEGER     NOT NULL,  -- kbps
    upload_speed     INTEGER     NOT NULL,  -- kbps
    download_burst   INTEGER     NOT NULL,  -- kbit
    upload_burst     INTEGER     NOT NULL,  -- kbit
    price            NUMERIC(10,2) NOT NULL,
    is_active        BOOLEAN     NOT NULL DEFAULT true,
    created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Customers are the business entities (people or companies) that subscribe to services.
CREATE TABLE customers (
    id               SERIAL      PRIMARY KEY,
    name             TEXT        NOT NULL,
    email            TEXT,
    phone            TEXT,
    street           TEXT,
    city             TEXT,
    zip_code         TEXT,
    state            TEXT,
    created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Services bind a customer + plan to a physical network attachment point (circuit_id/remote_id).
-- When a DHCP session arrives, the system looks up the service by circuit_id/remote_id
-- to determine which plan (and therefore which bandwidth policy) to apply.
CREATE TABLE services (
    id               SERIAL      PRIMARY KEY,
    customer_id      INTEGER     NOT NULL REFERENCES customers(id),
    plan_id          INTEGER     NOT NULL REFERENCES plans(id) ON DELETE RESTRICT,

    -- Network binding: identifies the subscriber's physical attachment on the BNG
    circuit_id       TEXT        NOT NULL,
    remote_id        TEXT        NOT NULL,

    status           TEXT        NOT NULL DEFAULT 'ACTIVE',  -- ACTIVE | SUSPENDED | TERMINATED
    billing_start    DATE        NOT NULL DEFAULT CURRENT_DATE,

    created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at       TIMESTAMPTZ NOT NULL DEFAULT now(),

    UNIQUE (circuit_id, remote_id)
);

CREATE INDEX idx_services_customer_id ON services (customer_id);
CREATE INDEX idx_services_plan_id ON services (plan_id);
CREATE INDEX idx_services_status ON services (status);

-- Seed example plans (no services attached by default)
INSERT INTO plans (name, download_speed, upload_speed, download_burst, upload_burst, price, is_active) VALUES
    ('Bronze 25/10', 25000, 10000, 1000, 500, 29.99, true),
    ('Silver 100/30', 100000, 30000, 3000, 1200, 49.99, true),
    ('Gold 300/100', 300000, 100000, 8000, 3000, 79.99, true),
    ('Legacy 10/5', 10000, 5000, 500, 250, 19.99, false);

-- Seed example customers (OSS-side entities)
INSERT INTO customers (name, email, phone, street, city, zip_code, state) VALUES
    ('Acme Bakery', 'ops@acmebakery.example', '+1-555-0100', '101 Market St', 'Springfield', '01103', 'MA'),
    ('Northside Clinic', 'it@northsideclinic.example', '+1-555-0101', '22 Health Ave', 'Hartford', '06103', 'CT'),
    ('River Apartments', 'manager@riverapts.example', '+1-555-0102', '78 River Rd', 'Providence', '02903', 'RI'),
    ('Maya Patel', 'maya.patel@example.com', '+1-555-0103', '14 Oak Lane', 'Nashua', '03060', 'NH'),
    ('Downtown Deli', 'info@downtowndeli.example', '+1-555-0104', '55 Main St', 'Boston', '02108', 'MA'),
    ('Elm Street Dental', 'front@elmstreetdental.example', '+1-555-0105', '9 Elm St', 'Worcester', '01608', 'MA'),
    ('Harbor View Hotel', 'it@harborview.example', '+1-555-0106', '300 Wharf Blvd', 'Portland', '04101', 'ME'),
    ('Lakeside Gym', 'admin@lakesidegym.example', '+1-555-0107', '42 Lake Dr', 'Burlington', '05401', 'VT'),
    ('Pine Ridge School', 'tech@pineridge.example', '+1-555-0108', '88 Pine Rd', 'Concord', '03301', 'NH'),
    ('Summit Coffee', 'hello@summitcoffee.example', '+1-555-0109', '7 Summit Ave', 'Stamford', '06901', 'CT'),
    ('Jade Garden Restaurant', 'mgr@jadegarden.example', '+1-555-0110', '163 Garden Way', 'New Haven', '06510', 'CT'),
    ('Coastal Realty', 'office@coastalrealty.example', '+1-555-0111', '205 Shore Dr', 'Newport', '02840', 'RI');

-- Seed access routers
INSERT INTO access_routers (router_name, giaddr, bng_id, total_interfaces) VALUES
{% for node in all_access_nodes %}
    ('{{ node.remote_id }}', '{{ node.dhcp_addr }}', '{{ node.bng_id }}', {{ node.iface_count }}){% if not loop.last %},{% else %};{% endif %}
{% endfor %}
