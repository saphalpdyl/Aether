name: isp-lab

topology:
  nodes:
{% for host in hosts %}
    {{ host.name }}:
      kind: linux
      image: lab-host
      env:
        HOST_MAC: {{ host.mac | tojson }}

{% endfor %}
{% for node in access_nodes %}
    {{ node.container_name }}:
      kind: linux
      image: lab-relay
      env:
        REMOTE_ID: {{ node.remote_id | tojson }}
        GIADDR: {{ node.dhcp_addr | tojson }}
        CIRCUIT_ID_MAP: {{ node.circuit_id_map | tojson }}
        RELAY_BR_IP_CIDR: {{ (node.dhcp_addr ~ '/' ~ node.subnet_prefix) | tojson }}
        RELAY_UPLINK_IP_CIDR: {{ node.uplink_cidr | tojson }}
        RELAY_DEFAULT_GW: {{ node.uplink_default_gw | tojson }}
      exec:
{% for cmd in node.relay_exec %}
        - {{ cmd | tojson }}
{% endfor %}

{% endfor %}
    agg:
      kind: linux
      image: lab-agg

    {{ bng.bng_node_name }}:
      kind: linux
      image: lab-bng
      env:
{% for key, value in bng_env.items() %}
        {{ key }}: {{ value | tojson }}
{% endfor %}
      exec:
{% for cmd in bng_exec %}
        - {{ cmd | tojson }}
{% endfor %}

    mgmt:
      kind: linux
      image: alpine:latest
      exec:
        - "sh -c \"ip link add br0 type bridge 2>/dev/null || true\""
        - "sh -c \"ip link set br0 up\""
        - "sh -c \"for i in $(seq 1 11); do ip link set eth${i} up; ip link set eth${i} master br0; done\""

    kea:
      kind: linux
      image: lab-kea
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "ip link set eth1 up"
        - "ip addr add 198.18.0.3/24 dev eth1"
        - "ip route replace default via 198.18.0.254"
        - "sh -c \"for i in $(seq 1 60); do pg_isready -h 198.18.0.4 -U kea >/dev/null 2>&1 && break; sleep 0.5; done\""
        - "sh -c \"kea-admin db-init pgsql -u kea -p test -n kea_lease_db -h 198.18.0.4 || true\""
        - "mkdir -p /run/kea && chmod 777 /run/kea"
        - "sh -c \"KEA_LOCKFILE_DIR=none kea-dhcp4 -c /etc/kea/kea-dhcp4.conf >/tmp/kea-dhcp4.log 2>&1 &\""
        - "sh -c \"rm -f /run/kea/kea-ctrl-agent.*.pid\""
        - "sh -c \"KEA_LOCKFILE_DIR=none kea-ctrl-agent -c /etc/kea/kea-ctrl-agent.conf >/tmp/kea-ctrl-agent.log 2>&1 &\""
        - "sh -c \"ip link set eth0 down || true\""

    radius:
      memory: 8Gb
      kind: linux
      image: lab-radius
      exec:
        - "sh -c \"/opt/radius/entrypoint.sh >/tmp/radius-entry.log 2>&1 &\""
        - "sh -c \"ip link set eth0 down || true\""

    radius_pg:
      kind: linux
      image: lab-radius-pg
      memory: 8Gb
      mgmt-ipv4: 172.20.20.11
      env:
        POSTGRES_DB: radius
        POSTGRES_USER: radius
        POSTGRES_PASSWORD: test
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "ip link set eth1 up"
        - "ip addr add 198.18.0.6/24 dev eth1"
        - "ip route replace default via 198.18.0.254"
        - "sh -c \"for i in $(seq 1 60); do pg_isready -h 127.0.0.1 -U radius >/dev/null 2>&1 && break; sleep 0.5; done\""
        - "sh -c \"/docker-entrypoint-initdb.d/00-radius-hba.sh || true\""
        - "sh -c \"pg_ctl -D \\\"$PGDATA\\\" reload || true\""

    dhcp_pg:
      kind: linux
      image: lab-dhcp-pg
      memory: 8Gb
      mgmt-ipv4: 172.20.20.12
      env:
        POSTGRES_DB: kea_lease_db
        POSTGRES_USER: kea
        POSTGRES_PASSWORD: test
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "ip link set eth1 up"
        - "ip addr add 198.18.0.4/24 dev eth1"
        - "ip route replace default via 198.18.0.254"

    redis:
      kind: linux
      image: lab-redis
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "ip link set eth1 up"
        - "ip addr add 198.18.0.10/24 dev eth1"
        - "ip route replace default via 198.18.0.254"
        - "sh -c \"ip link set eth0 down || true\""

    oss_pg:
      kind: linux
      image: lab-oss-pg
      memory: 8Gb
      mgmt-ipv4: 172.20.20.10
      env:
        POSTGRES_DB: oss
        POSTGRES_USER: oss
        POSTGRES_PASSWORD: oss
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "ip link set eth1 up"
        - "ip addr add 198.18.0.11/24 dev eth1"
        - "ip route replace default via 198.18.0.254"
        - "sh -c \"for i in $(seq 1 60); do pg_isready -h 127.0.0.1 -U oss >/dev/null 2>&1 && break; sleep 0.5; done\""
        - "sh -c \"/docker-entrypoint-initdb.d/00-oss-hba.sh || true\""
        - "sh -c \"pg_ctl -D \\\"$PGDATA\\\" reload || true\""

    frontend:
      kind: linux
      image: lab-frontend
      mgmt-ipv4: 172.20.20.20
      binds:
        - /home/test/lab/client/src:/app/src
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "ip link set eth1 up"
        - "ip addr add 198.18.0.20/24 dev eth1"
        - "ip route replace default via 198.18.0.254"
        - "sh -c \"pnpm dev --hostname 0.0.0.0 >/proc/1/fd/1 2>/proc/1/fd/2 &\""

    bng_ingestor:
      kind: linux
      image: lab-bng-ingestor
      env:
        REDIS_HOST: 198.18.0.10
        PG_HOST: 198.18.0.11
        PG_DB: oss
        PG_USER: oss
        PG_PASSWORD: oss
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "ip link set eth1 up"
        - "ip addr add 198.18.0.12/24 dev eth1"
        - "ip route replace default via 198.18.0.254"
        - "sh -c \"ip link set eth0 down || true\""

    backend:
      kind: linux
      image: lab-backend
      mgmt-ipv4: 172.20.20.21
      env:
        PG_HOST: 198.18.0.11
        PG_DB: oss
        PG_USER: oss
        PG_PASSWORD: oss
        RADIUS_PG_HOST: 198.18.0.6
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "ip link set eth1 up"
        - "ip addr add 198.18.0.21/24 dev eth1"
        - "ip route replace default via 198.18.0.254"
        - "sh -c \"for i in $(seq 1 60); do python3 -c 'import socket; s=socket.create_connection((\\\"198.18.0.11\\\",5432),2); s.close()' 2>/dev/null && break; sleep 1; done\""
        - "sh -c \"uvicorn main:app --host 0.0.0.0 --port 8000 >/proc/1/fd/1 2>/proc/1/fd/2 &\""

    upstream:
      kind: linux
      image: alpine:latest
      exec:
{% for cmd in upstream_exec %}
        - {{ cmd | tojson }}
{% endfor %}

  links:
{% for link in host_links %}
    - endpoints: [{{ link.host | tojson }}, {{ link.access | tojson }}]
{% endfor %}

{% for node in access_nodes %}
    - endpoints: [{{ (node.container_name ~ ':' ~ node.uplink_iface) | tojson }}, {{ ('agg:' ~ node.agg_iface) | tojson }}]
{% endfor %}

    - endpoints: [{{ ('agg:' ~ agg_bng_iface) | tojson }}, {{ (bng.bng_node_name ~ ':' ~ bng.subscriber_iface) | tojson }}]
    - endpoints: [{{ (bng.bng_node_name ~ ':' ~ bng.upstream_iface) | tojson }}, "upstream:eth1"]

    - endpoints: [{{ (bng.bng_node_name ~ ':' ~ bng.dhcp_uplink_iface) | tojson }}, "mgmt:eth1"]
    - endpoints: ["upstream:eth2", "mgmt:eth2"]
    - endpoints: ["kea:eth1", "mgmt:eth3"]
    - endpoints: ["radius:eth1", "mgmt:eth4"]
    - endpoints: ["radius_pg:eth1", "mgmt:eth5"]
    - endpoints: ["dhcp_pg:eth1", "mgmt:eth6"]
    - endpoints: ["redis:eth1", "mgmt:eth7"]
    - endpoints: ["oss_pg:eth1", "mgmt:eth8"]
    - endpoints: ["bng_ingestor:eth1", "mgmt:eth9"]
    - endpoints: ["frontend:eth1", "mgmt:eth10"]
    - endpoints: ["backend:eth1", "mgmt:eth11"]

    - endpoints: ["upstream:eth11", "macvlan:enp1s0"]
