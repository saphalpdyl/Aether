name: isp-lab

topology:
  nodes:
{% for host in host_nodes %}
    {{ host.name }}:
      kind: linux
      image: lab-host
      env:
        HOST_MAC: {{ host.mac | tojson }}

{% endfor %}
{% for node in access_nodes %}
    {{ node.container_name }}:
      kind: linux
      image: lab-relay
      env:
        REMOTE_ID: {{ node.remote_id | tojson }}
        GIADDR: {{ node.dhcp_addr | tojson }}
        RELAY_UPLINK_IFACE: {{ node.uplink_iface | tojson }}
        RELAY_ACCESS_IFACES: {{ (node.subscriber_ifaces | join(',')) | tojson }}
        CIRCUIT_ID_MAP: {{ node.circuit_id_map | tojson }}
        RELAY_BR_IP_CIDR: {{ (node.dhcp_addr ~ '/' ~ node.subnet_prefix) | tojson }}
        RELAY_UPLINK_IP_CIDR: {{ node.uplink_cidr | tojson }}
        RELAY_DEFAULT_GW: {{ node.uplink_default_gw | tojson }}
      exec:
        - {{ ("sh -c \"for i in $(seq 1 50); do " ~ node.wait_clause ~ " && break; sleep 0.2; done\"") | tojson }}
{% if node.subscriber_ifaces | length > 1 %}
        - "sh -c \"ip link add br0 type bridge 2>/dev/null || true\""
        - {{ ("sh -c \"" ~ node.up_clause ~ "\"") | tojson }}
        - {{ ("sh -c \"" ~ node.bridge_attach_clause ~ "\"") | tojson }}
        - "sh -c \"ip link set br0 up\""
        - {{ ("sh -c \"ip addr replace " ~ node.dhcp_addr ~ "/" ~ node.subnet_prefix ~ " dev br0\"") | tojson }}
{% else %}
        - {{ ("sh -c \"" ~ node.up_clause ~ "\"") | tojson }}
        - {{ ("sh -c \"ip addr replace " ~ node.dhcp_addr ~ "/" ~ node.subnet_prefix ~ " dev " ~ node.subscriber_ifaces[0] ~ "\"") | tojson }}
{% endif %}
        - {{ ("sh -c \"ip addr replace " ~ node.uplink_cidr ~ " dev " ~ node.uplink_iface ~ "\"") | tojson }}
        - {{ ("sh -c \"ip route replace default via " ~ node.uplink_default_gw ~ " dev " ~ node.uplink_iface ~ "\"") | tojson }}
        - "sh -c \"sysctl -w net.ipv4.ip_forward=1 || true\""
        - "sh -c \"ip link set eth0 down || true\""

{% endfor %}
{% for agg in agg_nodes %}
    {{ agg.name }}:
      kind: linux
      image: lab-agg

{% endfor %}
{% for bng in bng_nodes %}
    {{ bng.name }}:
      kind: linux
      image: lab-bng
      env:
{% for key, value in bng.env.items() %}
        {{ key }}: {{ value | tojson }}
{% endfor %}
      exec:
{% for cmd in bng.exec %}
        - {{ cmd | tojson }}
{% endfor %}

{% endfor %}
    {{ shared.upstream["wan-node-name"] }}:
      kind: linux
      image: lab-agg

    {{ shared.mgmt["node-name"] }}:
      kind: linux
      image: alpine:latest
      exec:
        - "sh -c \"ip link add br0 type bridge 2>/dev/null || true\""
        - "sh -c \"ip link set br0 up\""
        - "sh -c \"for i in $(seq 1 {{ mgmt_port_count }}); do ip link set eth${i} up; ip link set eth${i} master br0; done\""

    kea:
      kind: linux
      image: lab-kea
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.kea_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}
        - {{ ("sh -c \"for i in $(seq 1 60); do pg_isready -h " ~ services.dhcp_pg_ip ~ " -U kea >/dev/null 2>&1 && break; sleep 0.5; done\"") | tojson }}
        - {{ ("sh -c \"kea-admin db-init pgsql -u kea -p test -n kea_lease_db -h " ~ services.dhcp_pg_ip ~ " || true\"") | tojson }}
        - "mkdir -p /run/kea && chmod 777 /run/kea"
        - "sh -c \"KEA_LOCKFILE_DIR=none kea-dhcp4 -c /etc/kea/kea-dhcp4.conf >/tmp/kea-dhcp4.log 2>&1 &\""
        - "sh -c \"rm -f /run/kea/kea-ctrl-agent.*.pid\""
        - "sh -c \"KEA_LOCKFILE_DIR=none kea-ctrl-agent -c /etc/kea/kea-ctrl-agent.conf >/tmp/kea-ctrl-agent.log 2>&1 &\""
        - "sh -c \"ip link set eth0 down || true\""

    radius:
      memory: 8Gb
      kind: linux
      image: lab-radius
      exec:
        - "sh -c \"/opt/radius/entrypoint.sh >/tmp/radius-entry.log 2>&1 &\""
        - "sh -c \"ip link set eth0 down || true\""

    radius_pg:
      kind: linux
      image: lab-radius-pg
      memory: 8Gb
      mgmt-ipv4: 172.20.20.11
      env:
        POSTGRES_DB: radius
        POSTGRES_USER: radius
        POSTGRES_PASSWORD: test
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.radius_pg_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}
        - "sh -c \"for i in $(seq 1 60); do pg_isready -h 127.0.0.1 -U radius >/dev/null 2>&1 && break; sleep 0.5; done\""
        - "sh -c \"/docker-entrypoint-initdb.d/00-radius-hba.sh || true\""
        - "sh -c \"pg_ctl -D \\\"$PGDATA\\\" reload || true\""

    dhcp_pg:
      kind: linux
      image: lab-dhcp-pg
      memory: 8Gb
      mgmt-ipv4: 172.20.20.12
      env:
        POSTGRES_DB: kea_lease_db
        POSTGRES_USER: kea
        POSTGRES_PASSWORD: test
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.dhcp_pg_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}

    redis:
      kind: linux
      image: lab-redis
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.redis_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}
        - "sh -c \"ip link set eth0 down || true\""

    oss_pg:
      kind: linux
      image: lab-oss-pg
      memory: 8Gb
      mgmt-ipv4: 172.20.20.10
      env:
        POSTGRES_DB: oss
        POSTGRES_USER: oss
        POSTGRES_PASSWORD: oss
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.oss_pg_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}
        - "sh -c \"for i in $(seq 1 60); do pg_isready -h 127.0.0.1 -U oss >/dev/null 2>&1 && break; sleep 0.5; done\""
        - "sh -c \"/docker-entrypoint-initdb.d/00-oss-hba.sh || true\""
        - "sh -c \"pg_ctl -D \\\"$PGDATA\\\" reload || true\""

    frontend:
      kind: linux
      image: lab-frontend
      mgmt-ipv4: 172.20.20.20
      env:
        SIMULATOR_URL: {{ ("http://" ~ services.simulator_ip ~ ":" ~ services.simulator_port) | tojson }}
{% if not is_prod %}
      binds:
        - {{ lab_root }}/client/src:/app/src
{% endif %}
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.frontend_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}
{% if is_prod %}
        - "sh -c \"HOSTNAME=0.0.0.0 node .next/standalone/server.js >/proc/1/fd/1 2>/proc/1/fd/2 &\""
{% else %}
        - "sh -c \"pnpm dev --hostname 0.0.0.0 >/proc/1/fd/1 2>/proc/1/fd/2 &\""
{% endif %}

    bng_ingestor:
      kind: linux
      image: lab-bng-ingestor
      env:
        REDIS_HOST: {{ services.redis_ip }}
        PG_HOST: {{ services.oss_pg_ip }}
        PG_DB: oss
        PG_USER: oss
        PG_PASSWORD: oss
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.bng_ingestor_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}
        - "sh -c \"ip link set eth0 down || true\""

    nginx:
      kind: linux
      image: lab-nginx
      mgmt-ipv4: 172.20.20.23
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.nginx_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}
        - "sh -c \"nginx -g 'daemon off;' >/proc/1/fd/1 2>/proc/1/fd/2 &\""

    backend:
      kind: linux
      image: lab-backend
      mgmt-ipv4: 172.20.20.21
      env:
        PG_HOST: {{ services.oss_pg_ip }}
        PG_DB: oss
        PG_USER: oss
        PG_PASSWORD: oss
        RADIUS_PG_HOST: {{ services.radius_pg_ip }}
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.backend_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}
        - {{ ("sh -c \"for i in $(seq 1 60); do python3 -c 'import socket; s=socket.create_connection((\\\"" ~ services.oss_pg_ip ~ "\\\",5432),2); s.close()' 2>/dev/null && break; sleep 1; done\"") | tojson }}
        - {{ ("sh -c \"for i in $(seq 1 60); do python3 -c \\\"import psycopg2; c=psycopg2.connect(host='" ~ services.radius_pg_ip ~ "',dbname='radius',user='radius',password='test'); cur=c.cursor(); cur.execute(\\\\\\\"SELECT 1 FROM radusergroup LIMIT 1\\\\\\\"); c.close()\\\" 2>/dev/null && break; sleep 1; done\"") | tojson }}
        - "sh -c \"uvicorn main:app --host 0.0.0.0 --port 8000 >/proc/1/fd/1 2>/proc/1/fd/2 &\""

    simulator:
      kind: linux
      image: lab-simulator
      mgmt-ipv4: 172.20.20.22
      env:
        OSS_BACKEND_HOST: {{ services.backend_ip }}
      binds:
        - /var/run/docker.sock:/var/run/docker.sock
        - {{ lab_root }}/simulator.config.json:/opt/simulator/simulator.config.json
        - {{ lab_root }}/containerlab/topology.yml:/opt/simulator/topology.yaml
      exec:
        - "sh -c \"ip addr flush dev eth1 || true\""
        - "sh -c \"ip neigh flush dev eth1 2>/dev/null || true\""
        - "ip link set eth1 up"
        - {{ ("ip addr add " ~ services.simulator_ip ~ "/" ~ mgmt_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip route replace default via " ~ mgmt_gw) | tojson }}
        - "sh -c \"uvicorn main:app --host 0.0.0.0 --port 8000 >/proc/1/fd/1 2>/proc/1/fd/2 &\""

    {{ shared.upstream["upstream-node-name"] }}:
      kind: linux
      image: alpine:latest
      exec:
        - "apk add --no-cache iptables curl iperf3 ethtool"
        - "sysctl -w net.ipv4.ip_forward=1"
        - {{ ("ip addr add " ~ shared.upstream["internet-ip-cidr"] ~ " dev " ~ shared.upstream["internet-iface"]) | tojson }}
        - {{ ("ip route add default via " ~ shared.upstream["internet-gw"] ~ " dev " ~ shared.upstream["internet-iface"]) | tojson }}
        - "ip link set eth1 up"
        - "ip link set eth2 up"
        - {{ ("ip addr add " ~ upstream_default_gw ~ "/" ~ upstream_prefix ~ " dev eth1") | tojson }}
        - {{ ("ip addr add " ~ shared.upstream["mgmt-ip-cidr"] ~ " dev eth2") | tojson }}
        - {{ ("iptables -t nat -A POSTROUTING -s " ~ shared.upstream["mgmt-nat-source-cidr"] ~ " -o " ~ shared.upstream["internet-iface"] ~ " -j MASQUERADE") | tojson }}
{% for node in all_access_nodes %}
        - {{ ("iptables -t nat -A POSTROUTING -s " ~ node.dhcp_subnet ~ " -o " ~ shared.upstream["internet-iface"] ~ " -j MASQUERADE") | tojson }}
{% endfor %}
{% for bng in bngs %}
{% for node in bng.access_nodes %}
        - {{ ("ip route replace " ~ node.dhcp_subnet ~ " via " ~ bng.upstream_ip) | tojson }}
{% endfor %}
{% endfor %}
        - {{ ("iptables -t nat -A PREROUTING -i " ~ shared.upstream["internet-iface"] ~ " -p tcp --dport 80 -j DNAT --to-destination " ~ services.nginx_ip ~ ":80") | tojson }}
        - {{ ("iptables -t nat -A PREROUTING -i " ~ shared.upstream["internet-iface"] ~ " -p tcp --dport 443 -j DNAT --to-destination " ~ services.nginx_ip ~ ":443") | tojson }}
        - "sh -c \"ip link set eth0 down || true\""
        - "sh -c \"iperf3 -s -D\""

  links:
{% for link in links %}
    - endpoints: [{{ link.a | tojson }}, {{ link.b | tojson }}]
{% endfor %}
