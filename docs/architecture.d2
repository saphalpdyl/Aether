direction: right

title: {
  label: Aether — ISP Network Lab
  near: top-center
  shape: text
  style: {font-size: 24; bold: true}
}

# ═══════════════════════════════════════════
#  EDGE — Subscriber + Access
# ═══════════════════════════════════════════

edge: {
  style: {fill: "#f8fafc"; stroke: "#94a3b8"; border-radius: 8}

  subscribers: "Subscribers" {
    style: {fill: "#dbeafe"; stroke: "#3b82f6"; border-radius: 6; font-size: 11}
  }
  relays: "DHCP Relay\n+ Option 82" {
    shape: hexagon
    style: {fill: "#fed7aa"; stroke: "#ea580c"; font-size: 11}
  }
  agg: "L2 Agg" {shape: diamond; style: {font-size: 10}}

  subscribers -> relays -> agg
}

# ═══════════════════════════════════════════
#  BNG — Packet Processing
# ═══════════════════════════════════════════

bng: "BNG  (×N)" {
  style: {fill: "#d4edda"; stroke: "#28a745"; border-radius: 8; bold: true}

  sniffer: "AF_PACKET\nSniffer" {shape: parallelogram; style: {font-size: 10}}
  loop: "Async\nEvent Loop" {style: {font-size: 10; bold: true}}
  sessions: "Session\nManager" {style: {font-size: 10}}
  nft: "nftables\ncounters" {shape: cylinder; style: {font-size: 9}}
  shaper: "TC/HTB\nshaper" {style: {font-size: 9}}
  dispatcher: "Event\nDispatcher" {shape: queue; style: {font-size: 10; fill: "#b7e4c7"}}

  sniffer -> loop
  loop -> sessions
  sessions -> nft
  sessions -> shaper
  sessions -> dispatcher
}

edge.agg -> bng.sniffer {style.stroke: "#28a745"; style.stroke-width: 2}

# ═══════════════════════════════════════════
#  NETWORK SERVICES
# ═══════════════════════════════════════════

services: {
  style: {fill: "#fff8f0"; stroke: "#d97706"; border-radius: 8}

  kea: "Kea DHCP\n:67 · ctrl :6772" {style: {fill: "#fff3cd"; stroke: "#ffc107"; border-radius: 6; font-size: 10}}
  radius: "FreeRADIUS\nAuth :1812 · Acct :1813" {style: {fill: "#f8d7da"; stroke: "#dc3545"; border-radius: 6; font-size: 10}}
  upstream: "Upstream\nNAT · iperf3" {style: {fill: "#e2e3e5"; stroke: "#6c757d"; border-radius: 4; font-size: 10}}
}

bng.loop -> services.kea: "DHCP relay +\nlease reconcile" {style.stroke: "#ffc107"; style.font-size: 9}
bng.loop -> services.radius: "Access-Req\nAcct Start/Stop" {style.stroke: "#dc3545"; style.font-size: 9}
bng -> services.upstream {style.stroke: "#6c757d"; style.stroke-dash: 3}

# ═══════════════════════════════════════════
#  EVENT BUS
# ═══════════════════════════════════════════

bus: {
  style: {fill: "#fff0f6"; stroke: "#d63384"; border-radius: 8}

  redis: "Redis Stream\nbng_events" {shape: queue; style: {fill: "#fce4ec"; stroke: "#e53935"; font-size: 10}}
  events: "SESSION_START · UPDATE · STOP\nPOLICY_APPLY · ROUTER_UPDATE\nBNG_HEALTH_UPDATE" {shape: page; style: {fill: "#fff"; stroke: "#d63384"; font-size: 8}}

  redis -> events {style.stroke-dash: 5; style.stroke: "#ddd"}
}

bng.dispatcher -> bus.redis: "XADD\n(seq-idempotent)" {style.stroke: "#e53935"; style.stroke-width: 2; style.font-size: 9}

# ═══════════════════════════════════════════
#  INGESTOR
# ═══════════════════════════════════════════

ingestor: "Ingestor\nXREADGROUP" {
  style: {fill: "#f3e5f5"; stroke: "#9c27b0"; border-radius: 6; bold: true; font-size: 11}
}

bus.redis -> ingestor {style.stroke: "#9c27b0"; style.stroke-width: 2}

# ═══════════════════════════════════════════
#  STORAGE
# ═══════════════════════════════════════════

storage: {
  style: {fill: "#e8f4fd"; stroke: "#0d6efd"; border-radius: 8}

  oss: "OSS PostgreSQL" {
    style: {fill: "#cfe2ff"; stroke: "#0d6efd"; border-radius: 6; bold: true; font-size: 10}
    t: "session_events · sessions_active\nsessions_history · access_routers\nbng_registry · bng_health_events\ncustomers · plans · services" {shape: cylinder; style: {font-size: 8}}
  }
  dhcp: "DHCP PG" {
    style: {fill: "#fff3cd"; stroke: "#ffc107"; border-radius: 6; font-size: 10}
    t: "lease4" {shape: cylinder; style: {font-size: 8}}
  }
  rad: "RADIUS PG" {
    style: {fill: "#f8d7da"; stroke: "#dc3545"; border-radius: 6; font-size: 10}
    t: "radacct · radcheck\nradusergroup" {shape: cylinder; style: {font-size: 8}}
  }
}

ingestor -> storage.oss: "event writes" {style.stroke: "#0d6efd"; style.font-size: 9}
services.kea -> storage.dhcp {style.stroke: "#ffc107"; style.stroke-dash: 3}
services.radius -> storage.rad {style.stroke: "#dc3545"; style.stroke-dash: 3}

# ═══════════════════════════════════════════
#  API + UI
# ═══════════════════════════════════════════

api: "Backend\nFastAPI :8000" {style: {fill: "#e0cffc"; stroke: "#6f42c1"; border-radius: 6; bold: true; font-size: 11}}
ui: "Frontend\nNext.js :3000" {style: {fill: "#d5c5f5"; stroke: "#6f42c1"; border-radius: 6; bold: true; font-size: 11}}

storage.oss -> api: "read pool" {style.stroke: "#6f42c1"; style.font-size: 9}
ui -> api: "REST" {style.stroke: "#6f42c1"}

# ═══════════════════════════════════════════
#  SIMULATOR
# ═══════════════════════════════════════════

sim: "Simulator\nProvision → DHCP → Traffic" {
  style: {fill: "#d1fae5"; stroke: "#059669"; border-radius: 6; font-size: 10; bold: true}
}

sim -> api: "POST services" {style.stroke: "#059669"; style.stroke-dash: 3; style.font-size: 9}
sim -> edge.subscribers: "docker exec" {style.stroke: "#059669"; style.stroke-dash: 3; style.font-size: 9}

# ═══════════════════════════════════════════
#  MANAGEMENT
# ═══════════════════════════════════════════

host: "Host Machine" {style: {fill: "#f1f5f9"; stroke: "#475569"; border-radius: 4; font-size: 10}}
host -> ui: "SSH tunnel" {style.stroke: "#6c757d"; style.stroke-dash: 5; style.font-size: 9}
